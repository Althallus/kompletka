<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Tato funkce se spustí, až když je načten celý obsah stránky.
    // Tím předejdeme chybám, kdyby se skript snažil pracovat s prvky, které ještě neexistují.
    
    function initializeForm() {
        // Logika pro radio butony, které zobrazují/skrývají hlavní sekce
        const radioToggles = document.querySelectorAll('input[type="radio"][data-target]');
        radioToggles.forEach(radio => {
            radio.addEventListener('change', function() {
                const targetElement = document.getElementById(this.dataset.target);
                if (!targetElement) return;

                // Zobrazíme, jen pokud je hodnota "Ano"
                targetElement.style.display = (this.value === 'Ano' && this.checked) ? 'block' : 'none';
            });
        });

        // Logika pro checkboxy, které zobrazují/skrývají pod-sekce (otázka 7)
        const checkboxToggles = document.querySelectorAll('input[type="checkbox"][data-sub-target]');
        checkboxToggles.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const subTargetElement = document.getElementById(this.dataset.subTarget);
                if (subTargetElement) {
                    subTargetElement.style.display = this.checked ? 'block' : 'none';
                }
            });
        });

        // Logika pro odeslání formuláře
        const form = document.getElementById('health-questionnaire-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const submitButton = document.getElementById('submit-button');
                const statusDiv = document.getElementById('status');
                submitButton.disabled = true;
                statusDiv.textContent = 'Odesílám data...';
                statusDiv.className = 'text-center';

                const formData = new FormData(form);
                const formObject = {};
                const checkboxGroups = {};

                formData.forEach((value, key) => {
                    const elements = form.querySelectorAll(`[name="${key}"]`);
                    if (elements.length > 0 && elements[0].type === 'checkbox') {
                        if (!checkboxGroups[key]) {
                            checkboxGroups[key] = [];
                        }
                        checkboxGroups[key].push(value);
                    } else {
                        formObject[key] = value;
                    }
                });
                Object.assign(formObject, checkboxGroups);

                google.script.run
                    .withSuccessHandler(onSuccess)
                    .withFailureHandler(onFailure)
                    .processForm(formObject);
            });
        }
    }

    function onSuccess(response) {
        const statusDiv = document.getElementById('status');
        const submitButton = document.getElementById('submit-button');
        statusDiv.textContent = response.message;
        statusDiv.className = 'text-center success-message'; // Třída pro úspěch
        submitButton.disabled = false;
        document.getElementById('health-questionnaire-form').reset();
        document.querySelectorAll('.details-group, .sub-details-group').forEach(el => el.style.display = 'none');
        window.scrollTo(0, 0);
    }

    function onFailure(error) {
        const statusDiv = document.getElementById('status');
        const submitButton = document.getElementById('submit-button');
        statusDiv.textContent = 'Chyba: ' + error.message;
        statusDiv.className = 'text-center error-message'; // Třída pro chybu
        submitButton.disabled = false;
    }

    // Spustíme inicializaci formuláře
    initializeForm();
});
</script>